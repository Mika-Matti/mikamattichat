
<html>
    <head>
        <title>mikamattiChat</title>

        <meta charset="UTF-8">
        <link rel='stylesheet' type='text/css' href='static/css/style.css' />
     <!--  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800' rel='stylesheet' type='text/css'> -->

        <script src="/socket.io/socket.io.js"></script>
        <script src="//code.jquery.com/jquery-1.11.1.js"></script>
    </head>

    <body>
    <div class='wrapper'>
        
    
        <div class='drawCanvas'>
        
       
        <div class='canvasHeader'>
            <h3>Welcome to mikamattiChat</h3>
        </div>
        <!-- tähän tulee online piirtotyökalu jossa kaikki chatissa olevat voivat piirtää yhdessä-->

        </div>

        <div class='chatContainer'>

            <div class='chatHeaderpre'>
                <h3>Set your nickname to get started</h3>
            </div>

            <!-- ylätunniste -->
            <div class='chatHeader'>
               <!-- <h3>Tervetuloa, <?php //echo ucwords($user); ?></h3> -->
               <h3 id='nickname'></h3>              
            </div>
                
            <div class='chatNames'>

                <div class='chatNamesheader'>
                <!-- idea täällä on saada numero näyttämään paikallaolijoiden määrä huoneessa-->
                Who is online
                <li id='connections'></li>
                </div>

                <!--nimimerkki-ikkuna oikealla -->
                <div class='chatNamesusers'>
                <!-- voisiko tämänkin tehdä jotenkin li classilla ja echolla ja poistaa tieto kun käyttäjän yhteys katkeaa? -->
                        
                <ul id='usernames'></ul> 

                </div>

                <!-- tänne tulee erikoisominaisuusnappuloita -->
                <div class='chatNamesbottom'>
                        [upload][cmnds]
                </div>
               
            </div>            

            <!-- Tässä asetetaan ensimäistä kertaa nimimerkki-->
            <div class='chatHeadertwo'>
                <form action='' id='change'>
 	            <input id='n' type='text' placeholder='Type your desired nickname here.' />
 	            <input type='submit' value='Set nick' />
                </form>	
              
            </div>

            <div class='chatHeaderthree'>
                <form action='' id='changeagain'>
 	            <input id='p' type='text' placeholder='Tired of your nickname? Change it here.' />
 	            <input type='submit' value='Change' />
                </form>	
              
            </div>

            

            <!-- viesti-ikkuna -->
            <div class="chatMessages">

                <ul id='messages'></ul> 

                
            </div>

            <!--divi joka näytetään nimettömälle henkilölle ennen chattiformia-->
            <div class='chatBottompre'>
                Before you can chat, you must set a nickname first.
            </div>
            <!-- alaosa jossa kirjotetaan viestit tämä ei näy enneku annetaan username koska css tiedostossa chatBottom display none-->
            <div class='chatBottom'>
                <form action='' id='send'>                  
                <input id='m' type='text' autocomplete='off' placeholder='Type your message here.' />
                <input type='submit' value='Send' />
                </form>
            </div>
            <!-- viestikirjotusosio loppuu -->
        
        </div>
    </div>
        <script>
                //Täällä tehdään kaikki tärkee kommunikointi serverin kanssa
                $(function ()
                {
                    let socket = io();    
                 
                    //NIMIMERKIN ASETTAMINEN
                    $('#change').submit(function(e)
                    {
                        e.preventDefault();
                        
                        if($('#n').val().length > 0 && $('#n').val().length < 14)
                        {
                            socket.emit('new user', $('#n').val(), function(data)
                            {
                                if(data)
                                {
                                    $('.chatBottompre').hide();     //sulkee varoitusviestin nimimerkin puutteesta
                                    $('.chatBottom').show();        //avaa chattiformin tilalle
                                    $('.chatHeadertwo').hide();     //sulkee set nick-formin
                                    $('.chatHeaderthree').show();   //ja avaa change nick-formin
                                    $('.chatHeaderpre').hide();     //Tervetuloa otsikko sulkeutuu
                                    $('.chatHeader').show();        //Ja uusi otsikko tulee tilalle
                                    $(".chatNamesbottom").show();   //Aukeaa myös erikoisnapit send-nappulan vieres(tähän tulee upload kuva feature)
                                    
                                    
                                }
                                else
                                {
                                    alert("That nickname is already taken!");
                                }
                                
                            });
                        }
                        else //jos nimimerkki on alle 1 kirjainta tai yli 20 kirjainta pitkä
                        {
                            alert("Type your nickname (max. 13 letters)");
                        }
                        $('#n').val(''); //tyhjentää kentän    
                        
                        
                    });
                    
                    //Kirjoita tähän kuinka käyttäjänimi ilmestyy huonelistalle
                    socket.on('get users', function(data)
                    {
                        var html = '';
                        for(i = 0; i < data.length; i++)
                        {
                            html += '<li class="usernames"><b>' + data[i] + '</b></li>';
                        }
                        $("#usernames").html(html);
                        
                    });    
                    //HUONELISTALOPPUU

                    //kokeillaan lisätä vain oma nimi ylhäälle
                    socket.on('get user', function(data)
                    {
                        var html = '';
                        html += 'Your current nickname is "' + data.user + '"';
                        $("#nickname").html(html);                        
                        
                    });
                    //NIMENVAIHTO LOPPUU                    

                    //TÄHÄN TULEE CONNECTIONS MÄÄRÄ JOKA MENEE 
                    socket.on('get connections', function(data)
                    {
                        var html = '';
                        html += "(" + data + ")";
                        $("#connections").html(html);
                    });
                    //CONNECTIONS LOPPUU

                    //has joined announcement
                    socket.on('joined server', function(data)
                    {
                        $("#messages").append("<li><i><b>" + data.user + "</b>" + " has joined the channel. </i></li>");
                        //Käskee ohjelman scrollata näyttö alas uuden viestin tullessa
                        scrollDown();
                    });
                    //joined loppuu

                    //has left announcement
                    socket.on('left server', function(data)
                    {
                        $("#messages").append("<li><i><b>" + data.user + "</b>" + " has left the channel. </i></li>");
                        //Käskee ohjelman scrollata näyttö alas uuden viestin tullessa
                        scrollDown();
                    });
                    //left server loppuu
                    //changed name alkaa
                    socket.on('changed namestart', function(data)
                    {
                        $("#messages").append("<li><b><i>*" + data.user + "</b>" + " has forsaken their old name and</i></li>");
                        //Käskee ohjelman scrollata näyttö alas uuden viestin tullessa
                        scrollDown();
                    });
                    socket.on('changed nameend', function(data)
                    {
                        $("#messages").append("<li><i>is now known as <b>" + data.user + "" + "*</i></b></li>");
                        //Käskee ohjelman scrollata näyttö alas uuden viestin tullessa
                        scrollDown();
                    });
                    //changed name loppuu
                           
                     //NIMENVAIHTO 
                    $('#changeagain').submit(function(e)
                    {
                        e.preventDefault();

                        
                            if($('#p').val().length > 0 && $('#p').val().length < 14)
                            {
                                
                                socket.emit('change user', $('#p').val(), function(data)
                                {
                                    if(data) //tarkistetaan onko nimi jo arrayssa
                                    {
                                        //alert("Nimi vaihdettu.");
                                    }
                                    else
                                    {
                                        alert("That nickname is already taken!");
                                    }

                                });                              
                                
                            }
                            else //jos nimimerkki on alle 1 kirjainta tai yli 20 kirjainta pitk
                            {
                                alert("Type your nickname (max. 13 letters)");
                            }

                            $('#p').val(''); //tyhjentää kentän            
                        

                    });

                    //CHATVIESTINLÄHETTÄMINEN
                    $('#send').submit(function(e)
                    {
                        e.preventDefault();

                        if($('#m').val().length > 0)//katsotaan onko viesti tyhjä ehdolla
                        {
                            //server.js puolella sitten otetaan koppi tästä
                            socket.emit('chat message', $('#m').val(), function(data)
                            {
                                alert("Bad whisper: " + data); // ottaa serveriltä callback viestit jos whisper on tyhjä tai käyttäjää ei ole
                            });
                            $('#m').val(''); //tyhjentää kentän
                           // return false;
                        }
                        else
                        {
                            alert("Write a message.");
                           // return false;
                        }
                    });

                    

                    //viesti tulee clientside ikkunaan
                    socket.on('new message', function(data)
                    {
                        //viestin lähetys
                        $("#messages").append("<li>" + getCurrentDate() + " <b>" + data.user + "</b>" + ": " + data.msg + "</li>");
                 
                        //Käskee ohjelman scrollata näyttö alas uuden viestin tullessa
                        scrollDown();

                    });

                    //yksityisviesti
                    socket.on('whisper', function(data)
                    {
                         //viestin lähetys
                         $("#messages").append("<li><i style=\"color:purple;\">" + getCurrentDate() +  " <b style=\"color:purple;\">" + data.user + " whispers</b>" + ": " + data.msg + "</i></li>");
                 
                        //Käskee ohjelman scrollata näyttö alas uuden viestin tullessa
                        scrollDown();
                    });
            
                });

                function scrollDown()
                {
                    //ja alla laitetaan scrollbar alas, jotta uusin viesti olisi aina näkyvissä alhaalla aina viestin tullessa
                        //Toistaiseksi tarvii ekan kerran scrollin ilmestyessä scrollata alas, mutta sen jälkeen toimii automaattisesti.
                        //toisinsanoen pitäisi kai heti scrollin ilmestyessä kutsua scrolldownia
                        var s = $(".chatMessages").scrollTop(),
                            d = $(document.documentElement).height(),
                            c = $(".chatMessages").height();
                        var scrollPercent = (s / (d - c)) * 100;
                        if ( (s / (d - c)) * 100 >= 90 )
                        {       
                                            
                            $(".chatMessages").stop().animate({ scrollTop: $(".chatMessages")[0].scrollHeight}, 0);
                        
                        }           
                        //scrollaustestailu loppuu
                }
                // TIMESTAMP
                function getCurrentDate() 
                {
                    var currentDate = new Date();
                    // var day = (currentDate.getDate() < 10 ? '0' : '') + currentDate.getDate();
                    // var month = ((currentDate.getMonth() + 1) < 10 ? '0' : '') + (currentDate.getMonth() + 1);
                    //var year = currentDate.getFullYear();
                    var hour = (currentDate.getHours() < 10 ? '0' : '') + currentDate.getHours();
                    var minute = (currentDate.getMinutes() < 10 ? '0' : '') + currentDate.getMinutes();
                    //var second = (currentDate.getSeconds() < 10 ? '0' : '') + currentDate.getSeconds();
                    //return year + "-" + month + "-" + day + " " + hour + ":" + minute + ":" + second;
                    return hour + ":" + minute;
                }

            
                </script>

    </body>
</html>